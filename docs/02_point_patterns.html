<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Spatial analysis of public health data - 2&nbsp; Point patterns and autocorrelation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03_obesity.html" rel="next">
<link href="./01_geographic_data.html" rel="prev">
<link href="./assets/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/fitvids-2.1.1/fitvids.min.js"></script>


  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./general_images/casa_logo.jpg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Spatial analysis of public health data</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
    <a href="https://github.com/oxford-mgh-2526/spatial-analysis-of-public-health-practicals" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02_point_patterns.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Point patterns and autocorrelation</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Software installation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_geographic_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Geographic information</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_point_patterns.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Point patterns and autocorrelation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_obesity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Exploring the Spatial Distribution of Points in the Presence of Covariates - Fast-Food Outlets and Schools in London</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_spatial_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spatial models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_food_bank_accessibility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Food bank accessibility</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Datasets</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-outcomes" id="toc-learning-outcomes" class="nav-link active" data-scroll-target="#learning-outcomes"><span class="header-section-number">2.1</span> Learning outcomes</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">2.2</span> Introduction</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">2.3</span> Data</a>
  <ul class="collapse">
  <li><a href="#wrangle-data" id="toc-wrangle-data" class="nav-link" data-scroll-target="#wrangle-data"><span class="header-section-number">2.3.1</span> Wrangle data</a></li>
  </ul></li>
  <li><a href="#point-patterns" id="toc-point-patterns" class="nav-link" data-scroll-target="#point-patterns"><span class="header-section-number">2.4</span> Point patterns</a>
  <ul class="collapse">
  <li><a href="#quadrat-analysis" id="toc-quadrat-analysis" class="nav-link" data-scroll-target="#quadrat-analysis"><span class="header-section-number">2.4.1</span> Quadrat analysis</a></li>
  <li><a href="#ripley-k" id="toc-ripley-k" class="nav-link" data-scroll-target="#ripley-k"><span class="header-section-number">2.4.2</span> Ripley K</a></li>
  <li><a href="#dbscan" id="toc-dbscan" class="nav-link" data-scroll-target="#dbscan"><span class="header-section-number">2.4.3</span> DBSCAN</a></li>
  </ul></li>
  <li><a href="#spatial-autocorrelation" id="toc-spatial-autocorrelation" class="nav-link" data-scroll-target="#spatial-autocorrelation"><span class="header-section-number">2.5</span> Spatial Autocorrelation</a>
  <ul class="collapse">
  <li><a href="#wrangle-data-1" id="toc-wrangle-data-1" class="nav-link" data-scroll-target="#wrangle-data-1"><span class="header-section-number">2.5.1</span> Wrangle data</a></li>
  <li><a href="#weight-matrix" id="toc-weight-matrix" class="nav-link" data-scroll-target="#weight-matrix"><span class="header-section-number">2.5.2</span> Weight matrix</a></li>
  <li><a href="#morans-i" id="toc-morans-i" class="nav-link" data-scroll-target="#morans-i"><span class="header-section-number">2.5.3</span> Moran’s I</a></li>
  <li><a href="#gearys-c" id="toc-gearys-c" class="nav-link" data-scroll-target="#gearys-c"><span class="header-section-number">2.5.4</span> Geary’s C</a></li>
  <li><a href="#getis-ord-general-g" id="toc-getis-ord-general-g" class="nav-link" data-scroll-target="#getis-ord-general-g"><span class="header-section-number">2.5.5</span> Getis Ord General G</a></li>
  </ul></li>
  <li><a href="#local-indicies-of-spatial-autocorrelation" id="toc-local-indicies-of-spatial-autocorrelation" class="nav-link" data-scroll-target="#local-indicies-of-spatial-autocorrelation"><span class="header-section-number">2.6</span> Local Indicies of Spatial Autocorrelation</a>
  <ul class="collapse">
  <li><a href="#morans-i-1" id="toc-morans-i-1" class="nav-link" data-scroll-target="#morans-i-1"><span class="header-section-number">2.6.1</span> Moran’s I</a></li>
  <li><a href="#getis-ord-g_i" id="toc-getis-ord-g_i" class="nav-link" data-scroll-target="#getis-ord-g_i"><span class="header-section-number">2.6.2</span> Getis Ord <span class="math inline">\(G_{i}^{*}\)</span></a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">2.6.3</span> Summary</a></li>
  </ul></li>
  <li><a href="#note" id="toc-note" class="nav-link" data-scroll-target="#note"><span class="header-section-number">2.7</span> Note</a>
  <ul class="collapse">
  <li><a href="#consider-what-this-all-means" id="toc-consider-what-this-all-means" class="nav-link" data-scroll-target="#consider-what-this-all-means"><span class="header-section-number">2.7.1</span> Consider what this all means</a></li>
  <li><a href="#extensions" id="toc-extensions" class="nav-link" data-scroll-target="#extensions"><span class="header-section-number">2.7.2</span> Extensions</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/oxford-mgh-2526/spatial-analysis-of-public-health-practicals/edit/main/02_point_patterns.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/oxford-mgh-2526/spatial-analysis-of-public-health-practicals/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Point patterns and autocorrelation</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Reading</strong></p>
<p>Point patterns</p>
<ul>
<li><p>Point Pattern Analysis (Chapter 11) + Spatial Autocorrelation (Chapter 13), <a href="https://mgimond.github.io/Spatial/chp11_0.html">Intro to GIS and Spatial Analysis by Gimond (2023)</a></p></li>
<li><p><a href="https://www.jstor.org/stable/622936?casa_token=4DYSo5OC8DoAAAAA%3A1pOLjSzI-B1C3vzist48teaoymA1TofxCYZoJN8bIuCGn7-819JFHJIe3SfqiUTyOMMRRUBTHpT9smJab8Ne6MWo1T1MyI8g6Uz4ym0mVF6xfO1tv4Av&amp;seq=1#metadata_info_tab_contents">Spatial Point Pattern Analysis and Its Application in Geographical Epidemiology, Gatrell et al.&nbsp;(1996)</a></p></li>
<li><p><a href="https://onlinelibrary.wiley.com/doi/10.1111/j.1538-4632.2009.00769.x">What Problem? Spatial Autocorrelation and Geographic Information Science</a> by Goodchild (2009).</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The task today is to evaluate access to affordable supermarkets in Glasgow. I’ve selected Glasgow as the report <a href="https://www.kelloggs.co.uk/content/dam/europe/kelloggs_gb/pdf/Kelloggs_Food_Desert_Brochure.pdf"><em>“A picture of Britain’s deprived food deserts”</em></a> commissioned by Kellogs identifies 8 of Scotland’s 10 most deprived food deserts within the city.</p>
<p>Whilst we can’t get a definitive answer to this from today’s session, we could look to see if:</p>
<ul>
<li>there are areas of dispersion or clustering (e.g.&nbsp;Moran’s I)</li>
<li>where there are intense high/low values (e.g.&nbsp;Getis Ord <span class="math inline">\(G_{i}^{*}\)</span> )</li>
<li>what distance clustering occurs (e.g.&nbsp;Ripley’s K)</li>
</ul>
<p>You do not need to produce a <em>final</em> answer, but come prepared to talk about the data, methods and issues tomorrow.</p>
<p><strong>Data</strong></p>
<ul>
<li>Boundary data
<ul>
<li><p>Similar to LSOAs but in Scotland these are called <em>Data Zones</em>, download the ESRI shapefile: <a href="https://spatialdata.gov.scot/geonetwork/srv/eng/catalog.search#/metadata/7d3e8709-98fa-4d71-867c-d5c8293823f2">https://spatialdata.gov.scot/geonetwork/srv/eng/catalog.search#/metadata/7d3e8709-98fa-4d71-867c-d5c8293823f2</a></p></li>
<li><p>Glasgow local authority boundary: <a href="https://geoportal.statistics.gov.uk/datasets/ons::local-authority-districts-may-2024-boundaries-uk-bfe-2/about">https://geoportal.statistics.gov.uk/datasets/ons::local-authority-districts-may-2024-boundaries-uk-bfe-2/about</a></p></li>
</ul></li>
<li>Supermarkets
<ul>
<li>We will use Open Street Map (OSM) to get the locations of supermarkets. OSM is Volunteered Geographic Information (VGI) where individuals have mapped features across the world that can be downloaded as spatial data. Features are categorised with <a href="https://wiki.openstreetmap.org/wiki/Map_features#Shop"><em>keys</em> and <em>values</em></a>:</li>
<li>Keys are topics (e.g.&nbsp;shop)</li>
<li>Values are specific features (e.g.&nbsp;supermarket)</li>
</ul></li>
</ul>
<p>We could also change the data to focus on convenience stores, where there is often less selection of <a href="https://www.resolvepoverty.org/wp-content/uploads/2018/11/Food-deserts-in-the-UK.pdf">healthy food and higher prices</a></p>
<p>There are many ways to access OSM:</p>
<ul>
<li>Geofabrik (all data) download: https://download.geofabrik.de/europe/united-kingdom/scotland.html</li>
<li>QGIS
<ul>
<li>Install the QuickOSM GIS plugin</li>
<li>Search for supermarket in your study area</li>
</ul></li>
<li>R package <code>osmdata</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(osmdata)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># you can just use the place name and it will look it up</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>Bounding_box <span class="ot">&lt;-</span> <span class="fu">getbb</span>(<span class="st">"Glasgow"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#or set it with an sf object</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#bbox &lt;- st_bbox(glasgow_zones)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># check it worked</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>Bounding_box </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># get the OSM data within the bounding box</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>glasgow_supermarkets <span class="ot">&lt;-</span> Bounding_box <span class="sc">%&gt;%</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opq</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"shop"</span>, </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># value="convenience"</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">value =</span> <span class="st">"supermarket"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a> <span class="fu">osmdata_sf</span>()</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>glasgow_supermarket_points <span class="ot">&lt;-</span> glasgow_supermarkets<span class="sc">$</span>osm_points</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<section id="learning-outcomes" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="learning-outcomes"><span class="header-section-number">2.1</span> Learning outcomes</h2>
<p>By the end of this practical you should be able to:</p>
<ol type="1">
<li>Describe and evaluate methods for analysing spatial patterns</li>
<li>Execute data cleaning and manipulation appropriate for analysis</li>
<li>Determine the locations of spatial clusters using point pattern analysis methods</li>
<li>Investigate the degree to which values at spatial points are similar (or different) to each other</li>
<li>Interpret the meaning of spatial autocorrelation in spatial data</li>
</ol>
<p>Today’s lecture is available online…at this URL: <a href="https://andrewmaclachlan.github.io/Spatial-analysis-of-public-health-data-24-points-and-autocorrelation/#1">https://andrewmaclachlan.github.io/Spatial-analysis-of-public-health-data-24-points-and-autocorrelation/#1</a></p>
<div class="cell">
<div class="cell-output-display">
<div class="shareagain" style="min-width:300px;margin:1em auto;" data-exeternal="1">
<iframe src="https://andrewmaclachlan.github.io/Spatial-analysis-of-public-health-data-24-points-and-autocorrelation/" width="1600" height="900" style="border:2px solid currentColor;" loading="lazy" allowfullscreen=""></iframe>
<script>fitvids('.shareagain', {players: 'iframe'});</script>
</div>
</div>
</div>
</section>
<section id="introduction" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="introduction"><span class="header-section-number">2.2</span> Introduction</h2>
<p>Today you will learn how to begin to analyse patterns in spatial data with points and spatially continuous observations.</p>
<p>The questions we want to answer are:</p>
<ol type="1">
<li><p>For any given London Ward, are Pharmacies distributed randomly or do they exhibit some kind of dispersed or clustered pattern</p></li>
<li><p>Are the values (in this case the density of pharmacies) similar (or dissimilar) across the wards of London.</p></li>
</ol>
<p>For this practical we are considering <strong>pharmacies as a single point in time</strong> (i.e.&nbsp;assuming that they will always be available when needed). However, some <a href="https://blog.rtwilson.com/pharmacy-late-night-opening-hours-analysis-featured-in-the-financial-times/">recent analysis Dr Robin Wilson</a> indicates that between 2022 and 2025, pharmacies open past 9pm on a week day has decreased by 95%, with some areas having very poor access. Additional methods such as <a href="https://miboraminima.github.io/stdbscan/">stdbscan</a> permits a temporal dimension but is beyond our scope here.</p>
</section>
<section id="data" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="data"><span class="header-section-number">2.3</span> Data</h2>
<p>Load our packages</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatstat)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get the pharmacy data: <a href="https://datashare.ed.ac.uk/handle/10283/2501">https://datashare.ed.ac.uk/handle/10283/2501</a> and load it</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pharmacy <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"prac2_data/PharmacyEW/PharmacyEW.shp"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#remove any duplicates</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `PharmacyEW' from data source 
  `C:\Users\Andy\OneDrive - University College London\Teaching\Guest\Oxford_26\spatial analysis of public health\spatial-analysis-of-public-health-data\prac2_data\PharmacyEW\PharmacyEW.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 10589 features and 11 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 137070 ymin: 19187 xmax: 655138 ymax: 653253
Projected CRS: OSGB36 / British National Grid</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check CRS</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(pharmacy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: OSGB36 / British National Grid 
  wkt:
PROJCRS["OSGB36 / British National Grid",
    BASEGEOGCRS["OSGB36",
        DATUM["Ordnance Survey of Great Britain 1936",
            ELLIPSOID["Airy 1830",6377563.396,299.3249646,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4277]],
    CONVERSION["British National Grid",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",49,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",-2,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996012717,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",400000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",-100000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    USAGE[
        SCOPE["Engineering survey, topographic mapping."],
        AREA["United Kingdom (UK) - offshore to boundary of UKCS within 49°45'N to 61°N and 9°W to 2°E; onshore Great Britain (England, Wales and Scotland). Isle of Man onshore."],
        BBOX[49.75,-9.01,61.01,2.01]],
    ID["EPSG",27700]]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check with a plot</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(pharmacy) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Get the London ward data and load it <a href="https://data.london.gov.uk/dataset/statistical-gis-boundary-files-london">https://data.london.gov.uk/dataset/statistical-gis-boundary-files-london</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>wards<span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"prac2_data/statistical-gis-boundaries-london/statistical-gis-boundaries-london/ESRI/London_Ward_CityMerged.shp"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(.,<span class="dv">27700</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `London_Ward_CityMerged' from data source 
  `C:\Users\Andy\OneDrive - University College London\Teaching\Guest\Oxford_26\spatial analysis of public health\spatial-analysis-of-public-health-data\prac2_data\statistical-gis-boundaries-london\statistical-gis-boundaries-london\ESRI\London_Ward_CityMerged.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 625 features and 7 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9
Projected CRS: OSGB36 / British National Grid</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check CRS</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#st_crs(wards)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check with a plot</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(wards) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="wrangle-data" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="wrangle-data"><span class="header-section-number">2.3.1</span> Wrangle data</h3>
<p>As we can see above the pharmacy data is for the whole of the UK and we are just interested in London. So, we need to spatially subset our points within our study area…</p>
<p>Here, the second operator is blank <code>, ,</code> - this controls which columns are kept, although I’d rather keep all of them and manipulate with the <code>tidyverse</code> (e.g.&nbsp;<code>select(the columnns i want)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>pharmacysub <span class="ot">&lt;-</span> pharmacy[wards, , op<span class="ot">=</span>st_within]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#check with a plot</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(wards) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">col =</span> <span class="cn">NA</span>, <span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(pharmacysub) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col=</span><span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── tmap v3 code detected ───────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[v3-&gt;v4] `tm_polygons()`: use 'fill' for the fill color of polygons/symbols
(instead of 'col'), and 'col' for the outlines (instead of 'border.col').
[v3-&gt;v4] `tm_polygons()`: use `fill_alpha` instead of `alpha`.
This message is displayed once every 8 hours.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When we spatial subset data like this there are different topological relations we can specify. The default is intersects, but we could also use <code>pharmacysub &lt;- pharmacy[wards, , op=st_within]</code>, with the operator or op set to <code>st_within</code>, to identify points completely within the borough outline, <a href="http://postgis.net/workshops/postgis-intro/spatial_relationships.html">or a variety of other options</a> such as <code>st_overlaps</code>, <code>st_touches</code>, <code>st_contains</code>, <code>st_disjoint</code>. Any possible topological relationship you can think of a function will exist for it…visually this looks like the image below, where each tick denotes the relations that apply to the polygons. Note, that in several cases multiple topological relations would work.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="prac2_images/relations-1.png" class="img-fluid figure-img" width="600"></p>
<figcaption>Topological relations between vector geometries. Source: <a href="https://geocompr.robinlovelace.net/spatial-operations.html">Lovelace et al.&nbsp;2022</a></figcaption>
</figure>
</div>
</div>
</div>
<p>We can also just use the function which will have the indices of where they intersect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add sparse=false to get the complete matrix.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>intersect_indices <span class="ot">&lt;-</span><span class="fu">st_intersects</span>(wards, pharmacy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you have used a graphic user interface GIS before, this is the same as <code>select by location</code> (e.g.&nbsp;<a href="https://docs.qgis.org/3.22/en/docs/user_manual/processing_algs/qgis/vectorselection.html#select-by-location">select by location in QGIS</a>), and as using filter from <code>dplyr</code> is the same as <code>select by attribute</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>What is the <a href="https://gis.stackexchange.com/questions/345184/st-intersects-vs-st-within/345186#:~:text=ST_Intersects%3A%20https%3A%2F%2Fpostgis.net,of%20space%20then%20they%20intersect.&amp;text=For%20points%2C%20there%20is%20no,do%20the%20same%20with%20lines.">difference between intersects and within for points like ours?</a></p>
</div>
</div>
</section>
</section>
<section id="point-patterns" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="point-patterns"><span class="header-section-number">2.4</span> Point patterns</h2>
<p>For point pattern analysis we need a point pattern object (ppp)…within an observation window. This is specific to the <a href="https://spatstat.org/"><code>spatstat</code></a> package as we can’t do this with <code>sf</code>, SpatialPolygonsDataFrames or SpatialPointsDataFrames.</p>
<p>For this example i will set the boundary to London so we can see the points</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>boroughs <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"prac2_data/statistical-gis-boundaries-london/statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(.,<span class="dv">27700</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `London_Borough_Excluding_MHW' from data source 
  `C:\Users\Andy\OneDrive - University College London\Teaching\Guest\Oxford_26\spatial analysis of public health\spatial-analysis-of-public-health-data\prac2_data\statistical-gis-boundaries-london\statistical-gis-boundaries-london\ESRI\London_Borough_Excluding_MHW.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 33 features and 7 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9
Projected CRS: OSGB36 / British National Grid</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#now set a window as the borough boundary</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>window <span class="ot">&lt;-</span> <span class="fu">as.owin</span>(boroughs)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(window)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create a sp object</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>pharmacysubsp<span class="ot">&lt;-</span> pharmacysub <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as</span>(., <span class="st">'Spatial'</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">#create a ppp object</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>pharmacysubsp.ppp <span class="ot">&lt;-</span> <span class="fu">ppp</span>(<span class="at">x=</span>pharmacysubsp<span class="sc">@</span>coords[,<span class="dv">1</span>],</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">y=</span>pharmacysubsp<span class="sc">@</span>coords[,<span class="dv">2</span>],</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">window=</span>window)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>pharmacysubsp.ppp <span class="sc">%&gt;%</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(.,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">cex=</span><span class="fl">0.5</span>, </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">main=</span><span class="st">"Pharmacies in London"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="quadrat-analysis" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="quadrat-analysis"><span class="header-section-number">2.4.1</span> Quadrat analysis</h3>
<p>So as you saw in the lecture, we are interested in knowing whether the distribution of points in our study area differs from <strong><em>‘complete spatial randomness’ — CSR</em></strong>. That’s different from a CRS! Be careful!</p>
<p>The most basic test of CSR is a quadrat analysis. We can carry out a simple quadrat analysis on our data using the <code>quadrat count()</code> function in <code>spatstat</code>. Note, I wouldn’t recommend doing a quadrat analysis in any real piece of analysis you conduct, but it is useful for starting to understand the Poisson distribution…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#First plot the points</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pharmacysubsp.ppp,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch=</span><span class="dv">16</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex=</span><span class="fl">0.5</span>, </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"Pharmacies"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">#now count the points in that fall in a 20 x 20</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">#must be run all together otherwise there is a plot issue</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>pharmacysubsp.ppp <span class="sc">%&gt;%</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quadratcount</span>(.,<span class="at">nx =</span> <span class="dv">20</span>, <span class="at">ny =</span> <span class="dv">20</span>)<span class="sc">%&gt;%</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(., <span class="at">add=</span>T, <span class="at">col=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We want to know whether or not there is any kind of spatial patterning associated with pharmacies in areas of London. If you recall from the lecture, this means comparing our observed distribution of points with a statistically likely (Complete Spatial Random) distribution, based on the Poisson distribution.</p>
<p>Using the same <code>quadratcount()</code> function again (for the same sized grid) we can save the results into a table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#run the quadrat count</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>qcount <span class="ot">&lt;-</span> pharmacysubsp.ppp <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quadratcount</span>(.,<span class="at">nx =</span> <span class="dv">20</span>, <span class="at">ny =</span> <span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(<span class="at">var1=</span>Freq)<span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">freqquadratcount=</span>n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>OK, so we now have a frequency table — next we need to calculate our expected values. The formula for calculating expected probabilities based on the Poisson distribution is:</p>
<p><span class="math display">\[Pr= (X =k) = \frac{\lambda^{k}e^{-\lambda}}{k!}\]</span> where:</p>
<ul>
<li><p><code>x</code> is the number of occurrences</p></li>
<li><p><code>λ</code> is the mean number of occurrences</p></li>
<li><p><code>e</code> is a constant- 2.718</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">&lt;-</span> qcount <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#calculate the total blue plaques (Var * Freq)</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> var1 <span class="sc">*</span> freqquadratcount) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># then the sums</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), sum))<span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>var1) </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>lambda<span class="ot">&lt;-</span> qcount<span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#calculate lambda - sum of freq count / sum of total plaques</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> var1 <span class="sc">*</span> freqquadratcount)<span class="sc">%&gt;%</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), sum)) <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lambda=</span>total<span class="sc">/</span>freqquadratcount) <span class="sc">%&gt;%</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(lambda)<span class="sc">%&gt;%</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(lambda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Calculate expected using the Poisson formula from above <span class="math inline">\(k\)</span> is the number of pharmacies counted in a square and is found in the first column of our table…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>qcounttable <span class="ot">&lt;-</span> qcount <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Probability of number of plaques in quadrant using the formula </span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pr=</span>((lambda<span class="sc">^</span>var1)<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>lambda))<span class="sc">/</span><span class="fu">factorial</span>(var1))<span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#now calculate the expected counts based on our total number of plaques</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#and save them to the table</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expected=</span> (<span class="fu">round</span>(pr <span class="sc">*</span> sums<span class="sc">$</span>freqquadratcount, <span class="dv">0</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot them</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>qcounttable_long <span class="ot">&lt;-</span> qcounttable <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="st">"freqquadratcount"</span>, <span class="st">"expected"</span>), </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to=</span><span class="st">"countvs_expected"</span>, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to=</span><span class="st">"value"</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(qcounttable_long, <span class="fu">aes</span>(var1, value)) <span class="sc">+</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">colour =</span> countvs_expected ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Check for association between two categorical variables - we are looking to see if our freqneucy is similar to the expected (which is random)</p>
<p>To check for sure, we can use the <code>quadrat.test()</code> function, built into <code>spatstat</code>. This uses a Chi Squared test to compare the observed and expected frequencies for each quadrant (rather than for quadrant bins, as we have just computed above).</p>
<p>A Chi-Squared test determines if there is an association between two categorical variables. The higher the Chi-Squared value, the greater the difference.</p>
<p>If the p-value of our Chi-Squared test is &lt; 0.05, then we can reject a null hypothesis that says “there is no pattern - i.e.&nbsp;complete spatial randomness - in our data” (think of a null-hypothesis as the opposite of a hypothesis that says our data exhibit a pattern). What we need to look for is a value for p &gt; 0.05. If our p-value is &gt; 0.05 then this indicates that we have CSR and there is no pattern in our points. If it is &lt; 0.05, this indicates that we do have clustering in our points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>teststats <span class="ot">&lt;-</span> <span class="fu">quadrat.test</span>(pharmacysubsp.ppp, <span class="at">nx =</span> <span class="dv">20</span>, <span class="at">ny =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Some expected counts are small; chi^2 approximation may be inaccurate</code></pre>
</div>
</div>
<p>Chi square with a p value &lt; 0.05 therefore some clustering…but from the plot, this was expected</p>
</section>
<section id="ripley-k" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="ripley-k"><span class="header-section-number">2.4.2</span> Ripley K</h3>
<p>One way of getting around the limitations of quadrat analysis is to compare the observed distribution of points with the Poisson random model for a whole range of different distance radii. This is what Ripley’s K function computes. We can conduct a Ripley’s K test on our data very simply with the <code>spatstat</code> package using the <code>kest()</code> function.</p>
<p>Ripley’s K is defined as…</p>
<p><span class="math display">\[K(r) = \lambda^{-1} \sum{i}\sum{j}\frac{I(d_ij&lt;r)}{n}\]</span></p>
<ul>
<li><p>In English: Ripley’s K value for any circle radius <span class="math inline">\(r\)</span> =</p>
<ul>
<li><p>The average density of points for the <strong>entire study region (of all locations)</strong> <span class="math inline">\(\lambda = (n/ \Pi r^2))\)</span></p></li>
<li><p>Multiplied by the sum of the distances <span class="math inline">\(d_ij\)</span> between all points within that search radius, see <a href="https://www3.nd.edu/~mhaenggi/ee87021/Dixon-K-Function.pdf">Dixon page 2</a> and <a href="file:///C:/Users/Andy/Downloads/Extending_Ripleys_K-Function_to_Quantify_Aggregat%20(1).pdf">Amgad et al.&nbsp;2015</a></p></li>
<li><p>Divided by the total number of points, n</p></li>
<li><p>I = 1 or 0 depending if <span class="math inline">\(d_ij &lt; r\)</span></p></li>
</ul></li>
</ul>
<p>The plot for K has a number of elements that are worth explaining. First, the <em>Kpois(r)</em> line in Red is the theoretical value of K for each distance window (r) under a Poisson assumption of Complete Spatial Randomness. The Black line is the estimated values of K accounting for the effects of the edge of the study area.</p>
<p>Here, the correction specifies how points towards the edge are dealt with, in this case, border means that points towards the edge are ignored for the calculation but are included for the central points. <a href="https://www.statistics.gov.hk/wsc/IPS031-P2-S.pdf">Section 2.1, here</a> explains the different options.</p>
<p>Where the value of K falls above the line, the data appear to be clustered at that distance. Where the value of K is below the line, the data are dispersed…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> pharmacysubsp.ppp <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Kest</span>(., <span class="at">correction=</span><span class="st">"border"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This was sort of expected too due to our previous analysis - suggesting that there is clustering throughout the points.</p>
</section>
<section id="dbscan" class="level3" data-number="2.4.3">
<h3 data-number="2.4.3" class="anchored" data-anchor-id="dbscan"><span class="header-section-number">2.4.3</span> DBSCAN</h3>
<p>Quadrat and Ripley’s K analysis are useful exploratory techniques for telling us if we have spatial clusters present in our point data, but they are not able to tell us WHERE in our area of interest the clusters are occurring. To discover this we need to use alternative techniques. One popular technique for discovering clusters in space (be this physical space or variable space) is DBSCAN. For the complete overview of the DBSCAN algorithm, read the original paper by <a href="http://www.aaai.org/Papers/KDD/1996/KDD96-037.pdf">Ester et al.&nbsp;(1996)</a> or consult the <a href="https://en.wikipedia.org/wiki/DBSCAN">wikipedia page</a></p>
<p>DBSCAN requires you to input two parameters: 1. <em>Epsilon</em> - this is the radius within which the algorithm with search for clusters 2. <em>MinPts</em> - this is the minimum number of points that should be considered a cluster</p>
<p>We could use the output of Ripley’s K to inform <em>Epsilon</em> or alternatively we can use <code>kNNdistplot()</code> from the <code>dbscan</code> package to find a suitable eps value based on the ‘knee’ in the plot…</p>
<p><code>kNNdistplot()</code> take the average distance to all neighbours then ploits the values in ascending order, where the “knee” is indicates a sudden increase in distance to neighbours.</p>
<p>For <em>MinPts</em> we typically start with 4. But, try increasing the value of k in <code>kNNdistplot</code> you will notice as you increase it the knee becomes less obvious.</p>
<ul>
<li><p>If we have <em>MinPts</em> too low we have a massive cluster</p></li>
<li><p>If we have <em>MinPts</em> too high we have a small single cluster</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#first extract the points from the spatial points data frame</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>pharmacysub_coords <span class="ot">&lt;-</span> pharmacysub <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_coordinates</span>(.)<span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>pharmacysub_coords<span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  dbscan<span class="sc">::</span><span class="fu">kNNdistplot</span>(.,<span class="at">k=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>I started with an eps of 1600 and a minpts of 20..however…the large eps means that the city centre has a massive cluster…this isn’t exactly what i wanted to pull out. Instead i want to identify local clusters of pharmacies so try reducing the eps to 500 and the minpts to 5</p>
<p>OPTICS will let us remove the eps parameter but running every possible value, however, minpts is always <a href="https://stats.stackexchange.com/questions/88872/a-routine-to-choose-eps-and-minpts-for-dbscan">meant to be domain knowledge</a></p>
<p>Depending on your points it might be possible to filter the values you aren’t interested in - this isn’t the case here, but for example stop and search data or flytipping could be filtered (well, depending on the extra data within the columns)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#now run the dbscan analysis</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> pharmacysub_coords <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  fpc<span class="sc">::</span><span class="fu">dbscan</span>(.,<span class="at">eps =</span> <span class="dv">500</span>, <span class="at">MinPts =</span> <span class="dv">5</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">#now plot the results</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(db, pharmacysub_coords, <span class="at">main =</span> <span class="st">"DBSCAN Output"</span>, <span class="at">frame =</span> F)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wards<span class="sc">$</span>geometry, <span class="at">add=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Our new <code>db</code> object contains lots of info including the cluster each set of point coordinates belongs to, whether the point is a seed point or a border point etc. We can get a summary by just calling the object. We can now add this cluster membership info back into our dataframe</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>pharmacysub_coords<span class="ot">&lt;-</span> pharmacysub_coords <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dbcluster=</span>db<span class="sc">$</span>cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now create a <code>ggplot2</code> object from our data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>pharmacysub_coordsgt0 <span class="ot">&lt;-</span> pharmacysub_coords <span class="sc">%&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dbcluster<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>dbplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>wards)<span class="sc">+</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>()<span class="sc">+</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>pharmacysub_coordsgt0, </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">aes</span>(X,Y, <span class="at">colour=</span>dbcluster, <span class="at">fill=</span>dbcluster))</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">#add the points in</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>dbplot <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">coord_sf</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, this identifies where we have clustering based on our criteria but it doesn’t show where we have similar densities of pharmacies.</p>
</section>
</section>
<section id="spatial-autocorrelation" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="spatial-autocorrelation"><span class="header-section-number">2.5</span> Spatial Autocorrelation</h2>
<p>In this section we are going to explore patterns of spatially referenced continuous observations using various measures of spatial autocorrelation. Spatial autocorrelation is a measure of similarity between nearby data. We need to add all the points to the London wards then compute <strong><em>a density per ward</em></strong> could also use population here too! or some other data that can give us meaningful comparisons for our variable of interest.</p>
<section id="wrangle-data-1" class="level3" data-number="2.5.1">
<h3 data-number="2.5.1" class="anchored" data-anchor-id="wrangle-data-1"><span class="header-section-number">2.5.1</span> Wrangle data</h3>
<p>To do so we need to use a spatial join!</p>
<p>This is similar to the the joins (e.g.&nbsp;left joins) we explored with attribute data but here we just want to join datasets together based on their geometry and keep all their attribute data, this is useful in the code below where i want to join the pharmacies to the LSOA data</p>
<p>The output will be a massive dataset where each pharmacy will be a new row and will retain the attributes of the pharmacy data but also append the attribute of the LSOA.</p>
<p>The spatial join function,<code>st_join()</code>, defaults to a left join, so in this case the LSOA data is the left dataset and all the right data has been appended to it. If the left data (LSOA) had no matches (so no pharmacies) it would still appear in the final dataset. The default argument for this is <code>st_intersects</code> but we could also use other topological relationship functions such as <code>st_within()</code> instead…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>example<span class="ot">&lt;-</span><span class="fu">st_intersects</span>(wards, pharmacysub)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>example</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 625, where the
predicate was `intersects'
first 10 elements:
 1: (empty)
 2: 61, 65
 3: 53, 59
 4: 45, 54, 68
 5: 44, 48, 49, 62
 6: (empty)
 7: 60, 66
 8: 57
 9: 55
 10: 43, 56</code></pre>
</div>
</div>
<p>Here the polygon with the ID of 7, Chessington North and Hook, has two pharmacies within it…we can check this with <code>st_join</code> (or using QGIS by opening the data).</p>
<p>But note the ID column added is different to the ID of the data…open <code>pharmacysub</code> from the environment window and you will see the IDs that were returned in <code>st_intersects()</code>. The new IDs above take the data and apply 1 to n, where n is the end of the data. So if we subset our pharmacies on row 60 and 66 it will match our result here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>check_example <span class="ot">&lt;-</span> wards<span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(pharmacysub)<span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(GSS_CODE<span class="sc">==</span><span class="st">"E05000404"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>check_example</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 2 features and 18 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 517153.7 ymin: 164037.4 xmax: 519553 ymax: 165447.1
Projected CRS: OSGB36 / British National Grid
                          NAME  GSS_CODE HECTARES NONLD_AREA LB_GSS_CD
7   Chessington North and Hook E05000404   192.98          0 E09000021
7.1 Chessington North and Hook E05000404   192.98          0 E09000021
                 BOROUGH POLY_ID  ID      PCTName         NamePharm
7   Kingston upon Thames   50530 130 Kingston PCT Alliance Pharmacy
7.1 Kingston upon Thames   50530 136 Kingston PCT Alliance Pharmacy
           Address1    Address2    Address3 Address4 PostCode LSOAName Easting
7   11 North Parade Chessington      Surrey     &lt;NA&gt;  KT9 1QL     &lt;NA&gt;  518483
7.1 4 Arcade Parade        Hook Chessington   Surrey  KT9 1AB     &lt;NA&gt;  518015
    Northing                       geometry
7     164147 POLYGON ((517175.3 164077.3...
7.1   164508 POLYGON ((517175.3 164077.3...</code></pre>
</div>
</div>
<p>Now we just take the length of each list per polygon and add this as new column…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>points_sf_joined <span class="ot">&lt;-</span> wards<span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> <span class="fu">lengths</span>(<span class="fu">st_intersects</span>(., pharmacysub)))<span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()<span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#calculate area</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">area=</span><span class="fu">st_area</span>(.))<span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#then density of the points per ward</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density=</span>n<span class="sc">/</span>area)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now map density</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>points_sf_joined<span class="ot">&lt;-</span> points_sf_joined <span class="sc">%&gt;%</span>                    </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gss_code) <span class="sc">%&gt;%</span>         </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">density =</span> <span class="fu">first</span>(density),</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">name  =</span> <span class="fu">first</span>(gss_code))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(points_sf_joined) <span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="st">"density"</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">style=</span><span class="st">"jenks"</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">palette=</span><span class="st">"PuOr"</span>,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">midpoint=</span><span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── tmap v3 code detected ───────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[v3-&gt;v4] `tm_polygons()`: instead of `style = "jenks"`, use fill.scale =
`tm_scale_intervals()`.
ℹ Migrate the argument(s) 'style', 'midpoint', 'palette' (rename to 'values')
  to 'tm_scale_intervals(&lt;HERE&gt;)'
For small multiples, specify a 'tm_scale_' for each multiple, and put them in a
list: 'fill'.scale = list(&lt;scale1&gt;, &lt;scale2&gt;, ...)'
[cols4all] color palettes: use palettes from the R package cols4all. Run
`cols4all::c4a_gui()` to explore them. The old palette name "PuOr" is named
"brewer.pu_or"
Multiple palettes called "pu_or" found: "brewer.pu_or", "matplotlib.pu_or". The first one, "brewer.pu_or", is returned.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So, from the map, it looks as though we might have some clustering of pharmacies in the centre of London and a few other places, so let’s check this with Moran’s I and some other statistics.</p>
<p>As we saw in the session we need to create a spatial weight matrix…to do so we need centroid points first…to then compute the neighbours of each centroid…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>coordsW <span class="ot">&lt;-</span> points_sf_joined<span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_centroid</span>()<span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_geometry</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: st_centroid assumes attributes are constant over geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check, alpha is transparency </span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(points_sf_joined) <span class="sc">+</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="at">alpha=</span><span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(coordsW) <span class="sc">+</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── tmap v3 code detected ───────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[v3-&gt;v4] `tm_polygons()`: use `fill_alpha` instead of `alpha`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="weight-matrix" class="level3" data-number="2.5.2">
<h3 data-number="2.5.2" class="anchored" data-anchor-id="weight-matrix"><span class="header-section-number">2.5.2</span> Weight matrix</h3>
<p>Now we need to generate a spatial weights matrix (remember from the lecture). We’ll start with a simple binary matrix of queen’s case neighbours (otherwise known as Contiguity edges corners). This method means that polygons with a shared edge or a corner will be included in computations for the target polygon…A spatial weight matrix represents the spatial element of our data, this means we are trying to conceptualize and model how parts of the data are linked (or not linked) to each other spatially, using rules that we will set.</p>
<p>If the features share a boundary they are contiguous, this can also be classed as only common boundaries — a rook (like chess a rook can move forwards or side wards) or any point in common (e.g.&nbsp;corners / other boundaries) — a queen (like chess a queen can move forwards, backwards or on a diagonal).</p>
<p><strong>Alternatively</strong> instead of using contiguous relationships you can use distance based relationships. This is frequently done with k nearest neighbours in which k is set to the closest observations. e.g.&nbsp;K=3 means the three closest observations.</p>
<p>In the first instance we must create a neighbours list — which is a list of all the neighbours. To do so we will use polygon to neigbhour function <code>poly2nb()</code> with the argument <code>queen=T</code> saying we want a to use Queens case. Let’s see a summary of the output</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create a neighbours list</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>lward_nb <span class="ot">&lt;-</span> points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">poly2nb</span>(., <span class="at">queen=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Have a look at the summary of neighbours - average is 5.88</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lward_nb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 625 
Number of nonzero links: 3680 
Percentage nonzero weights: 0.94208 
Average number of links: 5.888 
Link number distribution:

  1   2   3   4   5   6   7   8   9  10  11  12 
  1   4  15  72 162 182 112  55  14   4   2   2 
1 least connected region:
380 with 1 link
2 most connected regions:
313 612 with 12 links</code></pre>
</div>
</div>
<p>plot them - we can’t use <code>tmap</code> as it isn’t the right class (e.g.&nbsp;it’s not an <code>sf</code> object)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lward_nb, <span class="fu">st_geometry</span>(coordsW), <span class="at">col=</span><span class="st">"red"</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co">#add a map underneath</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(points_sf_joined<span class="sc">$</span>geometry, <span class="at">add=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Next take our weight list and make it into a matrix through the neigbhour to matix function (<code>nb2mat</code>) …style here denotes the weight type:</p>
<ul>
<li>B is the basic binary coding (1/0)</li>
<li>W is row standardised (sums over all links to n)</li>
<li>C is globally standardised (sums over all links to n)</li>
<li>U is equal to C divided by the number of neighbours (sums over all links to unity)</li>
<li>S is the variance-stabilizing coding scheme proposed by Tiefelsdorf et al.&nbsp;1999, p.&nbsp;167-168 (sums over all links to n).</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create a spatial weights matrix from these weights</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>lward_lw <span class="ot">&lt;-</span> lward_nb <span class="sc">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nb2mat</span>(., <span class="at">style=</span><span class="st">"W"</span>,  <span class="at">zero.policy=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I have used row…based on the lecture what should the value of the weights sum to?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(lward_lw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 625</code></pre>
</div>
</div>
</section>
<section id="morans-i" class="level3" data-number="2.5.3">
<h3 data-number="2.5.3" class="anchored" data-anchor-id="morans-i"><span class="header-section-number">2.5.3</span> Moran’s I</h3>
<p>Moran’s I requires a spatial weight list type object as opposed to matrix, this is simply…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>lward_lw <span class="ot">&lt;-</span> lward_nb <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nb2listw</span>(., <span class="at">style=</span><span class="st">"W"</span>,  <span class="at">zero.policy=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s run Moran’s I. This test tells us whether the values at neighbouring sites are</p>
<ul>
<li>similar to the target site (giving a Moran’s I close to 1)</li>
<li>the value of the target is <strong>different</strong> to the neighbours (close to -1)</li>
<li>the values are random (0)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>i_lWard_global_density <span class="ot">&lt;-</span> points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(density) <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.vector</span>()<span class="sc">%&gt;%</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">moran.test</span>(., lward_lw, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The argument <code>zero.policy = TRUE</code> allows neighbours with no values.</p>
</section>
<section id="gearys-c" class="level3" data-number="2.5.4">
<h3 data-number="2.5.4" class="anchored" data-anchor-id="gearys-c"><span class="header-section-number">2.5.4</span> Geary’s C</h3>
<p>Geary’s C tells us whether similar values or dissimilar values are clustering.</p>
<p>It falls between 0 and 2; 1 means no spatial autocorrelation, &lt;1 - positive spatial autocorrelation or similar values clustering, &gt;1 - negative spatial autocorreation or dissimilar values clustering)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>c_lward_global_density <span class="ot">&lt;-</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(density) <span class="sc">%&gt;%</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.vector</span>()<span class="sc">%&gt;%</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geary.test</span>(., lward_lw, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="comparison" class="level4" data-number="2.5.4.1">
<h4 data-number="2.5.4.1" class="anchored" data-anchor-id="comparison"><span class="header-section-number">2.5.4.1</span> Comparison</h4>
<p>We should now have an idea about what the main differences between Moran’s I and Geary’s C are, and how to interpret the outputs. But how do these look in an equation. I really <strong>dislike using equations</strong> as a description is much easier to understand. However, it’s important to see how similar these two autocorrelcation measures are.</p>
<p><a href="">Download the worked Moran’s I and Geary’s C excel document</a> and consider it in relation to these formulas.</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Moran’s I</strong></th>
<th><strong>Geary’s C</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math display">\[I = \frac{n}{W} \cdot \frac{\sum_{i} \sum_{j} w_{ij} (z_i - \bar{z})(z_j - \bar{z})}{\sum_{i} (z_i - \bar{z})^2}\]</span></td>
<td><span class="math display">\[C = \frac{(n - 1)}{2W} \cdot \frac{\sum_{i} \sum_{j} w_{ij} (z_i - z_j)^2}{\sum_{i} (z_i - \bar{z})^2}\]</span></td>
</tr>
<tr class="even">
<td><strong>Where:</strong><br> ( n ) = number of spatial units<br> ( W = w_{ij} ) = sum of all spatial weights (1 if row standarised) <br> ( z_i ), ( z_j ) = value at location <em>i</em> and <em>j</em><br> ( {z} ) = mean of all values (global mean) <br> ( w_{ij} ) = spatial weight between <em>i</em> and <em>j</em></td>
<td><strong>Where:</strong><br> ( n ) = number of spatial units<br> ( W = w_{ij} ) = sum of all spatial weights (1 if row standarised)<br> ( z_i ), ( z_j ) = values at locations <em>i</em> and <em>j</em><br> ( {z} ) = mean of all values (global mean) <br> ( w_{ij} ) = spatial weight between <em>i</em> and <em>j</em></td>
</tr>
</tbody>
</table>
<ul>
<li>You will notice that the <strong>key difference is with the numerator</strong></li>
</ul>
<table class="table">
<colgroup>
<col style="width: 14%">
<col style="width: 34%">
<col style="width: 51%">
</colgroup>
<thead>
<tr class="header">
<th>Measure</th>
<th>What it compares</th>
<th>Mathematical focus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Moran’s I</strong></td>
<td>Value of unit vs <strong>global mean</strong></td>
<td>Cross-product: <span class="math inline">\((z_i - \bar{z})(z_j - \bar{z})\)</span></td>
</tr>
<tr class="even">
<td><strong>Geary’s C</strong></td>
<td>Value of unit vs <strong>neighbour</strong></td>
<td>Squared difference: <span class="math inline">\((z_i - z_j)^2\)</span></td>
</tr>
</tbody>
</table>
</section>
<section id="key-message" class="level4" data-number="2.5.4.2">
<h4 data-number="2.5.4.2" class="anchored" data-anchor-id="key-message"><span class="header-section-number">2.5.4.2</span> Key message</h4>
<p>For Moran’s I</p>
<ul>
<li><p>we are looking at the product of deviaitions from the global mean (subtracting our central value <span class="math inline">\((z_i - \bar{z})\)</span> and niehgbour <span class="math inline">\((z_j - \bar{z})\)</span> from the global mean individually, then multiplying them).</p></li>
<li><p>If both <strong>deviations are positive then this suggests clustering</strong></p></li>
</ul>
<p>For Geary’s C</p>
<ul>
<li><p>This changes to the difference between the central value and the neighbour, squared <span class="math inline">\((z_i - z_j)^2\)</span></p></li>
<li><p>A <strong>large difference means more dissimilarity between the values</strong></p></li>
</ul>
</section>
</section>
<section id="getis-ord-general-g" class="level3" data-number="2.5.5">
<h3 data-number="2.5.5" class="anchored" data-anchor-id="getis-ord-general-g"><span class="header-section-number">2.5.5</span> Getis Ord General G</h3>
<p>Getis Ord General G…? This tells us whether high or low values are clustering. If G &gt; Expected = High values clustering; if G &lt; expected = low values clustering. Again, this is conceptually similar to Moran’s I and Geary’s C but i won’t go into the detail here. The focus is now on the <em>weighted product of values</em> - this means multiplying neighbours and weighting them with our weight matrix (in the numerator). <strong>If a high value is near a high value it returns a larger product</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>g_lward_global_density <span class="ot">&lt;-</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(density) <span class="sc">%&gt;%</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.vector</span>()<span class="sc">%&gt;%</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">globalG.test</span>(., lward_lw, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in globalG.test(., lward_lw, zero.policy = TRUE): Binary weights
recommended (especially for distance bands)</code></pre>
</div>
</div>
<p>Based on the results write down what you can conclude here….</p>
</section>
</section>
<section id="local-indicies-of-spatial-autocorrelation" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="local-indicies-of-spatial-autocorrelation"><span class="header-section-number">2.6</span> Local Indicies of Spatial Autocorrelation</h2>
<section id="morans-i-1" class="level3" data-number="2.6.1">
<h3 data-number="2.6.1" class="anchored" data-anchor-id="morans-i-1"><span class="header-section-number">2.6.1</span> Moran’s I</h3>
<p>We can now also calculate local versions of the Moran’s I statistic (e.g.&nbsp;for each Ward) and a Getis Ord (G_{i}^{<em>}) statistic to spatially see and map </em>where* we have clusters…</p>
<p>This iterates over each individual polygon (or point), using just the neighbours for the spatial unit from our weight matrix.</p>
<p>Local Moran’s I is:</p>
<ul>
<li><p>The difference between a value and the global mean <span class="math inline">\((z_i - \bar{z})\)</span> * the difference between a neighbour and the global mean <span class="math inline">\(w_{ij}(z_j - \bar{z})\)</span>, weighted by the weight matrix</p></li>
<li><p>This is standarised by the global variance <span class="math inline">\((m_2)\)</span> to make sure values are comparable.</p></li>
</ul>
<p>[ I_i = <em>{j} w</em>{ij}(z_j - {z}) ]</p>
<p><strong>Where:</strong></p>
<ul>
<li>( I_i ): Local Moran’s I statistic for unit <em>i</em><br>
</li>
<li>( z_i ): Value at location <em>i</em><br>
</li>
<li>( z_j ): Value at neighboring location <em>j</em><br>
</li>
<li>( {z} ): Mean of all (global) values<br>
</li>
<li>( w_{ij} ): Spatial weight between locations <em>i</em> and <em>j</em><br>
</li>
<li>( m_2 = _{k=1}^{n} (z_k - {z})^2 ): Global variance
<ul>
<li>(z_k): is each individual value in the dataset</li>
</ul></li>
</ul>
<p>It returns several columns, of most interest is the Z score. A Z-score is <strong>how many standard deviations a value is away (above or below) from the mean</strong>. This allows us to state if our value is significantly different than expected value at this location considering the neighours.</p>
<p>We are comparing our value of Moran’s I to that of an expected value (computed from a separate equation that uses the spatial weight matrix, and therefore considers the neighbouring values). We are expecting our value of Moran’s I to be in the middle of the distribution of the expected values. These expected values follow a normal distribution, with the middle part representing complete spatial randomness. This is <strong>typically</strong> between &lt; -1.65 or &gt; +1.65 standard deviations from the mean</p>
<p>The <strong>null hypothesis</strong> is always there is complete spatial randomness. A null hypothesis means:</p>
<blockquote class="blockquote">
<p>no statistical significance exists in a set of given observations</p>
</blockquote>
<p>If our value is towards the tails of the distribution then it is unlikely that the value is completely spatially random and we can reject the null hypothesis…as it is not what we expect at this location.</p>
<p>In the example where we use a z-score of &gt;2.58 or &lt;-2.58 we interpret this as…</p>
<p>…&gt; 2.58 or &lt;-2.58 standard deviations away from the mean are significant at the 99% level…<strong><em>this means there is a &lt;1% chance that autocorrelation is not present</em></strong></p>
<p>The <a href="https://storymaps.arcgis.com/stories/5b26f25bb81a437b89003423505e2f71">Global vs location spatial autocorrelation resource</a> goes through the specific formulas here, but the most important parts are knowing</p>
<ul>
<li>What we are comparing values to in Local Moran’s I</li>
<li>What the results mean</li>
<li>Why the results could be important</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>i_lward_local_density <span class="ot">&lt;-</span> points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(density) <span class="sc">%&gt;%</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.vector</span>()<span class="sc">%&gt;%</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">localmoran</span>(., lward_lw, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)<span class="sc">%&gt;%</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This outputs a table, so we need to append that back to our sf of the wards to make a map…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>points_sf_joined <span class="ot">&lt;-</span> points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">density_i =</span><span class="fu">as.numeric</span>(i_lward_local_density<span class="sc">$</span>Ii))<span class="sc">%&gt;%</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">density_iz =</span><span class="fu">as.numeric</span>(i_lward_local_density<span class="sc">$</span>Z.Ii))<span class="sc">%&gt;%</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p =</span><span class="fu">as.numeric</span>(i_lward_local_density<span class="sc">$</span><span class="st">`</span><span class="at">Pr(z != E(Ii))</span><span class="st">`</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll set the breaks manually based on the rule that data points:&gt;2.58 or &lt;-2.58 standard deviations away from the mean are significant at the 99% level (&lt;1% chance that autocorrelation not present); &gt;1.96 - &lt;2.58 or &lt;-1.96 to &gt;-2.58 standard deviations are significant at the 95% level (&lt;5% change that autocorrelation not present). &gt;1.65 = 90% etc…like we saw in the lecture…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>breaks1<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dv">1</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>breaks2<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1000</span>,<span class="sc">-</span><span class="fl">2.58</span>,<span class="sc">-</span><span class="fl">1.96</span>,<span class="sc">-</span><span class="fl">1.65</span>,<span class="fl">1.65</span>,<span class="fl">1.96</span>,<span class="fl">2.58</span>,<span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now create a new diverging colour brewer palette and reverse the order using rev() (reverse) so higher values correspond to red - see <a href="https://www.r-graph-gallery.com/38-rcolorbrewers-palettes.html">https://www.r-graph-gallery.com/38-rcolorbrewers-palettes.html</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>MoranColours<span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">8</span>, <span class="st">"RdGy"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Remember Moran’s I - test tells us whether we have clustered values (close to 1) or dispersed values (close to -1) <strong>of similar values</strong> based on the spatial weight matrix that identifies the neighoburs.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>It should <strong>not</strong> be interpreted as a “hot spot”.</p>
</div>
</div>
<p>The z-score shows were this is unlikely because of complete spatial randomness and so we have spatial clustering (either clustering of similar or dissimilar values depending on the Moran’s I value) within these locations…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(points_sf_joined) <span class="sc">+</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="st">"density_i"</span>,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">style=</span><span class="st">"fixed"</span>,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks=</span>breaks1,</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">palette=</span>MoranColours,</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">midpoint=</span><span class="cn">NA</span>,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">title=</span><span class="st">"Local Moran's I"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── tmap v3 code detected ───────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[v3-&gt;v4] `tm_polygons()`: instead of `style = "fixed"`, use fill.scale =
`tm_scale_intervals()`.
ℹ Migrate the argument(s) 'style', 'breaks', 'midpoint', 'palette' (rename to
  'values') to 'tm_scale_intervals(&lt;HERE&gt;)'
For small multiples, specify a 'tm_scale_' for each multiple, and put them in a
list: 'fill'.scale = list(&lt;scale1&gt;, &lt;scale2&gt;, ...)'
[v3-&gt;v4] `tm_polygons()`: migrate the argument(s) related to the legend of the
visual variable `fill` namely 'title' to 'fill.legend = tm_legend(&lt;HERE&gt;)'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Values have found that are less than the lowest break. They are
assigned to the lowest interval</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Values have found that are higher than the highest break. They are
assigned to the highest interval</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(points_sf_joined) <span class="sc">+</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="st">"density_iz"</span>,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">style=</span><span class="st">"fixed"</span>,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks=</span>breaks2,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">palette=</span>MoranColours,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">midpoint=</span><span class="cn">NA</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">title=</span><span class="st">"Local Moran's I Z-score"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
── tmap v3 code detected ───────────────────────────────────────────────────────
[v3-&gt;v4] `tm_polygons()`: instead of `style = "fixed"`, use fill.scale =
`tm_scale_intervals()`.
ℹ Migrate the argument(s) 'style', 'breaks', 'midpoint', 'palette' (rename to
  'values') to 'tm_scale_intervals(&lt;HERE&gt;)'
For small multiples, specify a 'tm_scale_' for each multiple, and put them in a
list: 'fill'.scale = list(&lt;scale1&gt;, &lt;scale2&gt;, ...)'[v3-&gt;v4] `tm_polygons()`: migrate the argument(s) related to the legend of the
visual variable `fill` namely 'title' to 'fill.legend = tm_legend(&lt;HERE&gt;)'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-40-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="getis-ord-g_i" class="level3" data-number="2.6.2">
<h3 data-number="2.6.2" class="anchored" data-anchor-id="getis-ord-g_i"><span class="header-section-number">2.6.2</span> Getis Ord <span class="math inline">\(G_{i}^{*}\)</span></h3>
<p>What about the Getis Ord <span class="math inline">\(G_{i}^{*}\)</span> statistic for hot and cold spots…</p>
<p>This is a very similar concept to Local Moran’s I except it just returns a z-score…remember that a z-score shows <strong>how many standard deviations a value (our value) is away (above or below) from the mean (of the expected values)</strong></p>
<p>Ultimately a z-score is defined as:</p>
<p><span class="math display">\[Z = \frac{x-\mu}{\sigma}\]</span> Where:</p>
<ul>
<li><span class="math inline">\(x\)</span> = the observed value</li>
<li><span class="math inline">\(\mu\)</span> = the mean of the sample</li>
<li><span class="math inline">\(\sigma\)</span> = standard deviation of sample</li>
</ul>
<p><strong>Note</strong>, consult the <a href="https://storymaps.arcgis.com/stories/5b26f25bb81a437b89003423505e2f71">Global vs location spatial autocorrelation resource</a> for how this is computed in Local Moran’s I if you are interested, although interpretation is the most important part here.</p>
<p><strong>However</strong>, in the case of Getis Ord (G_{i}^{*}) this is the local sum (of the neighbourhood. This means for each point <span class="math inline">\(i\)</span> sum all of the surrounding values based on the weight matrix) <span class="math inline">\(\sum_{j} w_{ij} x_j\)</span> compared to the sum of all features in the entire dataset <span class="math inline">\(\sum_{j} x_j\)</span></p>
<p>[ G_i^* = ]</p>
<p>In Moran’s I this is just the value of the spatial unit (e.g.&nbsp;polygon of the ward) compared to the <strong>neighbouring units</strong>.</p>
<p>Here, to be significant (or a hot spot) we will have a high value surrounded by high values. The local sum of these values will be different to the expected sum (think of this as all the values in the area) then where this difference is large we can consider it to be not by chance…</p>
<p>The same z-score criteria then applies as before..</p>
<p>This summary from L3 Harris nicely summaries the Getis Ord <span class="math inline">\(G_{i}^{*}\)</span> output…</p>
<blockquote class="blockquote">
<p>The result of Getis Ord <span class="math inline">\(G_{i}^{*}\)</span> analysis is an array of Z-scores, one for each pixel [or polygon], which is the number of standard deviations that the pixel [or polygon] and its neighbors are from the global mean. High Z-scores indicate more intense clustering of high pixel values, indicating hot spots. Low Z-scores indicate more intense clustering of low values, indicating cold spots. Individual pixels with high or low values by themselves might be interesting but not necessarily significant.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>gi_lward_local_density <span class="ot">&lt;-</span> points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(density) <span class="sc">%&gt;%</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.vector</span>()<span class="sc">%&gt;%</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">localG</span>(., lward_lw)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>points_sf_joined <span class="ot">&lt;-</span> points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density_G =</span> <span class="fu">as.numeric</span>(gi_lward_local_density))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Note</strong> that because of the differences in Moran’s I and Getis Ord <span class="math inline">\(G_{i}^{*}\)</span> there will be differences between polygons that are classed as significant.</p>
<p>And map the outputs…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>gicolours<span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">8</span>, <span class="st">"RdBu"</span>))</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co">#now plot on an interactive map</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(points_sf_joined) <span class="sc">+</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="st">"density_G"</span>,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">style=</span><span class="st">"fixed"</span>,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks=</span>breaks2,</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">palette=</span>gicolours,</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">midpoint=</span><span class="cn">NA</span>,</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">title=</span><span class="st">"Gi* Z score"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── tmap v3 code detected ───────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[v3-&gt;v4] `tm_polygons()`: instead of `style = "fixed"`, use fill.scale =
`tm_scale_intervals()`.
ℹ Migrate the argument(s) 'style', 'breaks', 'midpoint', 'palette' (rename to
  'values') to 'tm_scale_intervals(&lt;HERE&gt;)'
For small multiples, specify a 'tm_scale_' for each multiple, and put them in a
list: 'fill'.scale = list(&lt;scale1&gt;, &lt;scale2&gt;, ...)'
[v3-&gt;v4] `tm_polygons()`: migrate the argument(s) related to the legend of the
visual variable `fill` namely 'title' to 'fill.legend = tm_legend(&lt;HERE&gt;)'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="summary" class="level3" data-number="2.6.3">
<h3 data-number="2.6.3" class="anchored" data-anchor-id="summary"><span class="header-section-number">2.6.3</span> Summary</h3>
<table class="table">
<colgroup>
<col style="width: 12%">
<col style="width: 28%">
<col style="width: 59%">
</colgroup>
<thead>
<tr class="header">
<th>Statistic</th>
<th>What is compared</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Local Moran’s I</strong></td>
<td>Deviation of a point from neibhouring values</td>
<td>Identify clusters or spatial outliers (similar/dissimilar)</td>
</tr>
<tr class="even">
<td><strong>Moran’s I Z-score</strong></td>
<td>Observed Moran’s I vs expected under randomness</td>
<td>Measure statistical significance of spatial autocorrelation at each location; high values surrounded by high values or low values surrounded by low values</td>
</tr>
<tr class="odd">
<td>**Getis-Ord (G_i^*)**</td>
<td>Local weighted sum vs global sum of all values</td>
<td>Identify hotspots (high values clustering) or coldspots (low values clustering)</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="note" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="note"><span class="header-section-number">2.7</span> Note</h2>
<p>In the analysis you might see a Moran plot where the values of our variable (density of pharmacies) and plotted against (on the y axis) the spatially lagged version (the average value of the same attribute at neighboring locations). <strong>However</strong> this plot below shows the value of density in relation to the spatial weight matrix…</p>
<p>This is useful as we can express the level of spatial association of each observation with its neighboring ones. Points in the upper right (or high-high) and lower left (or low-low) quadrants indicate positive spatial association of values that are higher and lower than the sample mean, respectively. The lower right (or high-low) and upper left (or low-high) quadrants include observations that exhibit negative spatial association; that is, these observed values carry little similarity to their neighboring ones.</p>
<p>Source: [STAT user guide](https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.4/statug/statug_variogram_details31.htm#:~:text=The%20Moran%20scatter%20plot%20(Anselin,known%20as%20the%20response%20axis.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>moran_plot_lward_global_density <span class="ot">&lt;-</span> points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(density)<span class="sc">%&gt;%</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.vector</span>()<span class="sc">%&gt;%</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">moran.plot</span>(., lward_lw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When you see Moran’s I out in the wild you will come across maps with:</p>
<ul>
<li>high values surrounded by high values (HH)</li>
<li>low values nearby other low values (LL)</li>
<li>low values among high values (LH)</li>
<li>high values among low values (HL)</li>
</ul>
<p>Here, we use the values we have, of density and Moran’s I, compared to the mean of density and Moran’s I (termed centering). Where the:</p>
<ul>
<li><p>value of density is greater than 0 and the value of Moran’s I is greater than 0 then high values (of density) are surrounded by other high values (from Moran’s I)= HH</p></li>
<li><p>value of density is lower than 0 and the value of Moran’s I is lower than 0 then low values (of density) are surrounded by other low values (from Moran’s I) = LL</p></li>
<li><p>value of density is lower than 0 and the value of Moran’s I is higher than 0 then low values (of density) are surrounded by high values (from Moran’s I) = LH</p></li>
<li><p>value of density is higher than 0 and the value of Moran’s I is lower than 0 then high values (of density) are surrounded by high values (from Moran’s I) =HL</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>signif <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="co"># centers the variable of interest around its mean</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>points_sf_joined2 <span class="ot">&lt;-</span> points_sf_joined <span class="sc">%&gt;%</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean_density =</span> density<span class="sc">-</span> <span class="fu">mean</span>(density))<span class="sc">%&gt;%</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean_density =</span> <span class="fu">as.vector</span>(mean_density))<span class="sc">%&gt;%</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean_densityI=</span> density_i <span class="sc">-</span> <span class="fu">mean</span>(density_i))<span class="sc">%&gt;%</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quadrant =</span> <span class="fu">case_when</span>(mean_density<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> mean_densityI <span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">~</span> <span class="dv">4</span>,</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>         mean_density<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> mean_densityI <span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>         mean_density<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> mean_densityI <span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>         mean_density<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> mean_densityI <span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">~</span> <span class="dv">3</span>))<span class="sc">%&gt;%</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quadrant=</span><span class="fu">case_when</span>(p <span class="sc">&gt;</span> signif <span class="sc">~</span> <span class="dv">0</span>, <span class="cn">TRUE</span> <span class="sc">~</span> quadrant))</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>)</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"white"</span>,<span class="st">"blue"</span>,<span class="st">"skyblue"</span>,<span class="st">"pink"</span>,<span class="st">"red"</span>)</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(points_sf_joined2) <span class="sc">+</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="st">"quadrant"</span>,</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">style=</span><span class="st">"fixed"</span>,</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks=</span>brks,</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"insignificant"</span>,<span class="st">"low-low"</span>,<span class="st">"low-high"</span>,<span class="st">"high-low"</span>,<span class="st">"high-high"</span>),</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">palette=</span>colors,</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">title=</span><span class="st">"Moran's I HH etc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── tmap v3 code detected ───────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[v3-&gt;v4] `tm_polygons()`: instead of `style = "fixed"`, use fill.scale =
`tm_scale_intervals()`.
ℹ Migrate the argument(s) 'style', 'breaks', 'palette' (rename to 'values'),
  'labels' to 'tm_scale_intervals(&lt;HERE&gt;)'
[v3-&gt;v4] `tm_polygons()`: migrate the argument(s) related to the legend of the
visual variable `fill` namely 'title' to 'fill.legend = tm_legend(&lt;HERE&gt;)'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_point_patterns_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Source: <a href="https://rpubs.com/quarcs-lab/spatial-autocorrelation">Carlos Mendez</a></p>
<p>This might seem somewhat confusing as if we look in the South East we have low values of Getis Ord <span class="math inline">\(G_{i}^{*}\)</span> yet we have shown that these are low (density) and high Moran’s I. But as <a href="https://www.mattpeeples.net/modules/LISA.html">Matthew Peeples</a> concisely summarises remember…</p>
<ul>
<li><p>Moran’s I is a measure of the degree to which the value at a target site is similar to values at adjacent sites. Moran’s I is large and positive when the value for a given target (or for all locations in the global case) is similar to adjacent values and negative when the value at a target is dissimilar to adjacent values.</p></li>
<li><p>Getis Ord <span class="math inline">\(G_{i}^{*}\)</span> identifies areas where high or low values cluster in space. It is high where the sum of values within a neighborhood of a given radius or configuration is high relative to <strong>the global average</strong> and negative where the sum of values within a neighborhood are small relative to the global average and approaches 0 at intermediate values.</p></li>
</ul>
<p>So here we have a high Moran’s I as the values around it are similar (probably all low) but a low Getis Ord as the values within the local area are low relative to the global average.</p>
<section id="consider-what-this-all-means" class="level3" data-number="2.7.1">
<h3 data-number="2.7.1" class="anchored" data-anchor-id="consider-what-this-all-means"><span class="header-section-number">2.7.1</span> Consider what this all means</h3>
<ul>
<li>Do you think Pharmacies take into account the ward they are in when they open?</li>
<li>Do you think people only go to pharmacies within their ward?</li>
<li>Pharmacies don’t exhibit complete spatial randomness and there seems to be clustering in certain locations….</li>
<li>Another question we could move onto is now are pharmacies locating around a need (e.g.&nbsp;health outcomes) and does that mean some of the population in London have poor access or choice.</li>
<li>For example….we could now look to see if there is clustering of “Deaths from causes considered preventable, under 75 years, standardised mortality ratio” and if that aligns with (or can be explained by) access / clusters of pharmacies.</li>
<li>If you wanted to do this (e.g.&nbsp;see if the ratio was clustered), the data is in a somewhat unfriendly format so you’d need to:
<ul>
<li>Download <a href="https://fingertips.phe.org.uk/profile/local-health/data#page/9/gid/1938133184/ati/8/iid/93227/age/1/sex/4/cat/-1/ctp/-1/yrr/5/cid/4/tbm/1">the public health profile ward data:</a></li>
<li>Read the Indicator definitions for the last row, specifically column G which tells us how it’s created.</li>
<li>Filter the data based on the indicator value of 93480 (from the Indicator definitions)</li>
<li>Filter out the London wards - as we did here and join it to our spatial feature.</li>
<li>Run a Moran’s I or some other spatial autocorrelation</li>
<li>Join this back to our spatial feature that has the Moran’s I for pharmacy density</li>
<li>Decide what to plot - does dispersion of pharmacies occur in the same spatial units as clustering of deaths considered preventable? This could simply be two maps and a table.</li>
</ul></li>
<li>Should it be a requirement to have access…well if we consult the “<a href="https://www.gov.uk/government/publications/community-pharmacy-contractual-framework-2019-to-2024/2021-to-2022-pharmacy-access-scheme-guidance">2022 Pharmacy Access Scheme: guidance</a>” then yes it appears so but…“Pharmacies in areas with dense provision of pharmacies remain excluded from the scheme”</li>
</ul>
</section>
<section id="extensions" class="level3" data-number="2.7.2">
<h3 data-number="2.7.2" class="anchored" data-anchor-id="extensions"><span class="header-section-number">2.7.2</span> Extensions</h3>
<ul>
<li>The use of OPTICS</li>
<li>We have spatial autocorrelation now can we try and model local differences in density of pharmacies - i.e.&nbsp;what factors might (or might not) explain the <a href="https://andrewmaclachlan.github.io/CASA0005repo/explaining-spatial-patterns.html">difference here</a></li>
<li>Or perhaps does the distance to pharmacies assist in explaining deaths from causes considered preventable, under 75 years. Similarly, we could even use this as a dummy variable (yes/no the areas is / is not in a cluster of pharmacies) in a regression model.</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./01_geographic_data.html" class="pagination-link" aria-label="Geographic information">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Geographic information</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03_obesity.html" class="pagination-link" aria-label="Exploring the Spatial Distribution of Points in the Presence of Covariates - Fast-Food Outlets and Schools in London">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Exploring the Spatial Distribution of Points in the Presence of Covariates - Fast-Food Outlets and Schools in London</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/oxford-mgh-2526/spatial-analysis-of-public-health-practicals/edit/main/02_point_patterns.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/oxford-mgh-2526/spatial-analysis-of-public-health-practicals/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>